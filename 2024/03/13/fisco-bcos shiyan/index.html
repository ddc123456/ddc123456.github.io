<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="基于FISCO-BCOS的一次实验1、设计一个智能合约设计预编译智能合约 预编译合约-头文件  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869  &#x2F;* * @CopyRight: * FI">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2024/03/13/fisco-bcos%20shiyan/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="基于FISCO-BCOS的一次实验1、设计一个智能合约设计预编译智能合约 预编译合约-头文件  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869  &#x2F;* * @CopyRight: * FI">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-03-13T07:57:22.362Z">
<meta property="article:modified_time" content="2021-12-29T12:59:35.765Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/rss2.xml" title="Hexo" type="application/rss+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-fisco-bcos shiyan" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/03/13/fisco-bcos%20shiyan/" class="article-date">
  <time class="dt-published" datetime="2024-03-13T07:57:22.362Z" itemprop="datePublished">2024-03-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="基于FISCO-BCOS的一次实验"><a href="#基于FISCO-BCOS的一次实验" class="headerlink" title="基于FISCO-BCOS的一次实验"></a>基于FISCO-BCOS的一次实验</h1><h2 id="1、设计一个智能合约"><a href="#1、设计一个智能合约" class="headerlink" title="1、设计一个智能合约"></a>1、设计一个智能合约</h2><h3 id="设计预编译智能合约"><a href="#设计预编译智能合约" class="headerlink" title="设计预编译智能合约"></a>设计预编译智能合约</h3><ul>
<li><h4 id="预编译合约-头文件"><a href="#预编译合约-头文件" class="headerlink" title="预编译合约-头文件"></a>预编译合约-头文件</h4></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">  /*</span><br><span class="line"> * @CopyRight:</span><br><span class="line"> * FISCO-BCOS is free software: you can redistribute it and/or modify</span><br><span class="line"> * it under the terms of the GNU General Public License as published by</span><br><span class="line"> * the Free Software Foundation, either version 3 of the License, or</span><br><span class="line"> * (at your option) any later version.</span><br><span class="line"> *</span><br><span class="line"> * FISCO-BCOS is distributed in the hope that it will be useful,</span><br><span class="line"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span><br><span class="line"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span><br><span class="line"> * GNU General Public License for more details.</span><br><span class="line"> *</span><br><span class="line"> * You should have received a copy of the GNU General Public License</span><br><span class="line"> * along with FISCO-BCOS.  If not, see &lt;http://www.gnu.org/licenses/&gt;</span><br><span class="line"> * (c) 2016-2018 fisco-dev contributors.</span><br><span class="line"> */</span><br><span class="line">/** @file BlockandFLPrecompiled.h</span><br><span class="line"> *  @author dudongcai</span><br><span class="line"> *  @date 20211102</span><br><span class="line"> */</span><br><span class="line">/*</span><br><span class="line">导入头文件：</span><br><span class="line">	&lt;libprecompiled/Common.h&gt;</span><br><span class="line"></span><br><span class="line">	&lt;libnlohmann_json/single_include/nlohmann/json.hpp&gt;</span><br><span class="line">*/</span><br><span class="line">#pragma once</span><br><span class="line">#include &lt;libprecompiled/Common.h&gt;</span><br><span class="line">#include &lt;libnlohmann_json/single_include/nlohmann/json.hpp&gt;</span><br><span class="line">//客户端数量</span><br><span class="line">#define client_num 20</span><br><span class="line">//学习率</span><br><span class="line">#define learning_rate 0.001</span><br><span class="line">using json = nlohmann::json;</span><br><span class="line">namespace dev</span><br><span class="line">&#123;</span><br><span class="line">	namespace precompiled</span><br><span class="line">	&#123;</span><br><span class="line">		class BlockandFLPrecompiled : public dev::precompiled::Precompiled</span><br><span class="line">		&#123;</span><br><span class="line">		public:</span><br><span class="line">			typedef std::shared_ptr&lt;BlockandFLPrecompiled&gt; Ptr; //定义指针</span><br><span class="line">			BlockandFLPrecompiled();   //定义构造函数</span><br><span class="line">			virtual ~BlockandFLPrecompiled()&#123;&#125;;  //定义析构函数</span><br><span class="line"></span><br><span class="line">			std::string toString() override;</span><br><span class="line"></span><br><span class="line">			PrecompiledExecResult::Ptr call(std::shared_ptr&lt;dev::blockverifier::ExecutiveContext&gt; _context,</span><br><span class="line">				bytesConstRef _param, Address const&amp; _origin = Address(),</span><br><span class="line">				Address const&amp; _sender = Address()) override;</span><br><span class="line">				/*_ context保存交易执行的上下文，_ param是调用合约的参数信息，本次调用对应合约接口以及接口的参数可以从_ param解析获取，_origin是交易发送者，用于权限控制。_sender是合约地址*/</span><br><span class="line">		private:</span><br><span class="line">			/*初始化全局模型*/</span><br><span class="line">			void InitGlobalModel(storage::Table::Ptr table, Address const&amp; _origin, PrecompiledExecResult::Ptr callResult);</span><br><span class="line"></span><br><span class="line">			/*模型聚合*/</span><br><span class="line">			void Aggregate(storage::Table::Ptr table, Address const&amp; _origin, PrecompiledExecResult::Ptr callResult, std::unordered_map&lt;std::string, std::string&gt;&amp; local_scores);</span><br><span class="line"></span><br><span class="line">			/*插入数据*/</span><br><span class="line">			void InsertVariable(storage::Table::Ptr table, Address const&amp; _origin, PrecompiledExecResult::Ptr callResult, const std::string &amp; Key, std::string &amp; strValue);</span><br><span class="line"></span><br><span class="line">			/*获取数据*/</span><br><span class="line">			std::string GetVariable(storage::Table::Ptr table, Address const&amp; _origin, PrecompiledExecResult::Ptr callResult, const std::string &amp; Key);</span><br><span class="line"></span><br><span class="line">			/*更新数据*/</span><br><span class="line">			void UpdateVariable(storage::Table::Ptr table, Address const&amp; _origin, PrecompiledExecResult::Ptr callResult, const std::string &amp; Key, std::string &amp; strValue);</span><br><span class="line">      &#125;;</span><br><span class="line">  &#125;  // namespace precompiled</span><br><span class="line">&#125;  // namespace dev</span><br></pre></td></tr></table></figure>

<ul>
<li><h4 id="预编译合约-源文件"><a href="#预编译合约-源文件" class="headerlink" title="预编译合约-源文件"></a>预编译合约-源文件</h4></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * @CopyRight:</span><br><span class="line"> * FISCO-BCOS is free software: you can redistribute it and/or modify</span><br><span class="line"> * it under the terms of the GNU General Public License as published by</span><br><span class="line"> * the Free Software Foundation, either version 3 of the License, or</span><br><span class="line"> * (at your option) any later version.</span><br><span class="line"> *</span><br><span class="line"> * FISCO-BCOS is distributed in the hope that it will be useful,</span><br><span class="line"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span><br><span class="line"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span><br><span class="line"> * GNU General Public License for more details.</span><br><span class="line"> *</span><br><span class="line"> * You should have received a copy of the GNU General Public License</span><br><span class="line"> * along with FISCO-BCOS.  If not, see &lt;http://www.gnu.org/licenses/&gt;</span><br><span class="line"> * (c) 2016-2018 fisco-dev contributors.</span><br><span class="line"> */</span><br><span class="line">/** @file BlockandFLPrecompiled.cpp</span><br><span class="line"> *  @author dudongcai</span><br><span class="line"> *  @date 20211102</span><br><span class="line"> */</span><br><span class="line">#include &quot;BlockandFLPrecompiled.h&quot;</span><br><span class="line">#include &lt;libblockverifier/ExecutiveContext.h&gt;</span><br><span class="line">#include &lt;libethcore/ABI.h&gt;</span><br><span class="line">#include &lt;libprecompiled/TableFactoryPrecompiled.h&gt;</span><br><span class="line"></span><br><span class="line">using namespace dev;</span><br><span class="line">using namespace dev::blockverifier;</span><br><span class="line">using namespace dev::storage;</span><br><span class="line">using namespace dev::precompiled;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/*怎么实现节点之间传递模型参数？</span><br><span class="line">怎么把节点传递模型参数的过程当作交易写上链？</span><br><span class="line">怎么在训练的过程中，计算每个节点的MAE，在计算之后，挑出矿工节点？*/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// data struct</span><br><span class="line">typedef std::unordered_map&lt;std::string, std::string&gt; Pair;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">* //智能合约</span><br><span class="line">contract CommitteePrecompiled&#123;</span><br><span class="line">    function RegisterNode() public;                                 //节点注册</span><br><span class="line">    function QueryState() public view returns(string, int);         //查询状态</span><br><span class="line">    function QueryGlobalModel() public view returns(string, int);   //获取全局模型</span><br><span class="line">    function UploadLocalUpdate(string update, int256 epoch) public; //上传本地模型（节点互传模型）</span><br><span class="line">    function UploadQUALITYScores(int256 epoch, string scores) public;      //上传模型质量评分</span><br><span class="line">    function QueryAllUpdates() public view returns(string);         //获取所有本地模型</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">*/</span><br><span class="line">template&lt;class T&gt;</span><br><span class="line">std::string to_json_string(T&amp; t)&#123;</span><br><span class="line">    json j = t;</span><br><span class="line">    return j.dump();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//创建表定义表名，表的字段结构</span><br><span class="line"></span><br><span class="line">// BlockandFLPrecompiled table name（创建BlockandFLPrecompiled表）</span><br><span class="line">const std::string Block_FL_TABLE_NAME = &quot;BlockandFL&quot;;</span><br><span class="line"></span><br><span class="line">// key field  主键字段</span><br><span class="line">const std::string Block_FL_KEY_FIELD = &quot;key&quot;;</span><br><span class="line">const std::string Block_FL_EPOCH_KEY_FIELD_NAME = &quot;epoch&quot;;  //当前迭代轮次(int)--&gt;触发链下训练</span><br><span class="line">const std::string Block_FL_ROLES_KEY_FIELD_NAME = &quot;roles&quot;;  //保存各个客户端的角色(unordered_map&lt;Adress,string&gt;)</span><br><span class="line">const std::string Block_FL_GLOBAL_MODEL_KEY_FIELD_NAME = &quot;global_model&quot;;  //保存全局模型(string)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 其他字段字段，多个字段使用逗号分割，比如 &quot;field0,field1,field2&quot;</span><br><span class="line">// value field</span><br><span class="line">const std::string Block_FL_VALUE_FIELD = &quot;value&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//interface name：接口名称</span><br><span class="line">const char* const REGISTER_NODE = &quot;RegisterNode()&quot;;                         //节点注册</span><br><span class="line">const char* const QUERY_STATE = &quot;QueryState()&quot;;                             //查询状态</span><br><span class="line">const char* const QUERY_GLOBAL_MODEL = &quot;QueryGlobalModel()&quot;;                //获取全局模型</span><br><span class="line">//const char* const UPLOAD_LOCAL_UPDATE = &quot;UploadLocalUpdate(string,int256)&quot;; //上传本地更新</span><br><span class="line">const char* const UPLOAD_SCORES = &quot;UploadScores(int256,string)&quot;;            //上传评分</span><br><span class="line">const char* const QUERY_ALL_UPDATES = &quot;QueryAllUpdates()&quot;;                  //获取所有本地模型</span><br><span class="line">const char* const UPDATED_GLOBAL_MODEL = &quot;UpdatedAllUpdates()&quot;;				//上传全局模型</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//构造函数--进行接口注册</span><br><span class="line">BlockandFLPrecompiled::BlockandFLPrecompiled()</span><br><span class="line">&#123;</span><br><span class="line">	// name2Selector是基类Precompiled类中成员，保存接口调用的映射关系</span><br><span class="line">	name2Selector[REGISTER_NODE] = getFuncSelector(REGISTER_NODE);</span><br><span class="line">    name2Selector[QUERY_STATE] = getFuncSelector(QUERY_STATE);</span><br><span class="line">    name2Selector[QUERY_GLOBAL_MODEL] = getFuncSelector(QUERY_GLOBAL_MODEL);</span><br><span class="line">    //name2Selector[UPLOAD_LOCAL_UPDATE] = getFuncSelector(UPLOAD_LOCAL_UPDATE);</span><br><span class="line">    name2Selector[UPLOAD_SCORES] = getFuncSelector(UPLOAD_SCORES);</span><br><span class="line">    name2Selector[QUERY_ALL_UPDATES] = getFuncSelector(QUERY_ALL_UPDATES);</span><br><span class="line">	name2Selector[UPDATED_GLOBAL_MODEL] = getFuncSelector(UPDATED_GLOBAL_MODEL);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PrecompiledExecResult::Ptr BlockandFLPrecompiled::call(</span><br><span class="line">    dev::blockverifier::ExecutiveContext::Ptr _context, bytesConstRef _param,</span><br><span class="line">    Address const&amp; _origin, Address const&amp;)</span><br><span class="line">&#123;</span><br><span class="line">    PRECOMPILED_LOG(TRACE) &lt;&lt; LOG_BADGE(&quot;BlockandFLPrecompiled&quot;) &lt;&lt; LOG_DESC(&quot;call&quot;)</span><br><span class="line">                           &lt;&lt; LOG_KV(&quot;param&quot;, toHex(_param));</span><br><span class="line"></span><br><span class="line">    // parse function name  ：解析函数名</span><br><span class="line">    uint32_t func = getParamFunc(_param);  //六位函数选择器，解析函数接口</span><br><span class="line"></span><br><span class="line">    bytesConstRef data = getParamData(_param);  //参数，解析函数参数</span><br><span class="line"></span><br><span class="line">    auto callResult = m_precompiledExecResultFactory-&gt;createPrecompiledResult();  //声明结果</span><br><span class="line"></span><br><span class="line">    callResult-&gt;gasPricer()-&gt;setMemUsed(_param.size());  //分配内存</span><br><span class="line"></span><br><span class="line">    dev::eth::ContractABI abi;  //声明abi</span><br><span class="line"></span><br><span class="line">	// the hash as a user-readable hex string with 0x perfix  哈希作为用户可读的十六进制字符串，带有 0x 前缀</span><br><span class="line">    std::string _origin_str = _origin.hexPrefixed();</span><br><span class="line"></span><br><span class="line">	//如果表存在打开,call函数中，表存在时打开，否则首先创建表</span><br><span class="line">    Table::Ptr table = openTable(_context, precompiled::getTableName(Block_FL_TABLE_NAME));</span><br><span class="line"></span><br><span class="line">    callResult-&gt;gasPricer()-&gt;appendOperation(InterfaceOpcode::OpenTable);</span><br><span class="line"></span><br><span class="line">    if (!table)</span><br><span class="line">    &#123;</span><br><span class="line">        // table is not exist, create it. 表不存在，首先创建</span><br><span class="line">        table = createTable(_context, precompiled::getTableName(Block_FL_TABLE_NAME),</span><br><span class="line">            Block_FL_EPOCH_KEY_FIELD_NAME, Block_FL_VALUE_FIELD, _origin);</span><br><span class="line"></span><br><span class="line">        callResult-&gt;gasPricer()-&gt;appendOperation(InterfaceOpcode::CreateTable);</span><br><span class="line">		// 创建表失败，返回错误码</span><br><span class="line">        if (!table)</span><br><span class="line">        &#123;</span><br><span class="line">            PRECOMPILED_LOG(ERROR) &lt;&lt; LOG_BADGE(&quot;BlockandFLPrecompiled&quot;) &lt;&lt; LOG_DESC(&quot;set&quot;)</span><br><span class="line">                                   &lt;&lt; LOG_DESC(&quot;open table failed.&quot;);</span><br><span class="line">            getErrorCodeOut(callResult-&gt;mutableExecResult(), storage::CODE_NO_AUTHORIZED);</span><br><span class="line">            return callResult;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	//节点注册接口实现</span><br><span class="line">    if (func == name2Selector[REGISTER_NODE])  //节点注册</span><br><span class="line">    &#123;  //输出一个数据，证明这个函数被调用了</span><br><span class="line">		node_str = &quot;node has been registered!&quot;;</span><br><span class="line">		callResult-&gt;setExecResult(abi.abiIn(&quot;&quot;, node_str)</span><br><span class="line">    &#125;</span><br><span class="line">    else if (func == name2Selector[QUERY_STATE]) //获取状态</span><br><span class="line">    &#123;</span><br><span class="line">		state_str = &quot;has been obtained the state of node !&quot;;</span><br><span class="line">        //callResult-&gt;setExecResult(abi.abiIn(&quot;&quot;, roles[_origin_str], s256(epoch)));</span><br><span class="line">		callResult-&gt;setExecResult(abi.abiIn(&quot;&quot;, state_str);</span><br><span class="line">    &#125;</span><br><span class="line">	else if (func == name2Selector[QUERY_GLOBAL_MODEL])&#123;        //获取全局模型</span><br><span class="line">		global_str = &quot;global model has been obtained!&quot;;</span><br><span class="line">		callResult-&gt;setExecResult(abi.abiIn(&quot;&quot;, global_str);</span><br><span class="line">	&#125;</span><br><span class="line">	else if (func == name2Selector[UPLOAD_LOCAL_UPDATE])&#123;       //上传本地更新</span><br><span class="line">        // get params  获取参数</span><br><span class="line">        std::string update;</span><br><span class="line">        s256 ep;</span><br><span class="line">        abi.abiOut(data, update, ep);</span><br><span class="line"></span><br><span class="line">		updated_local_str = &quot;local update has been updated!&quot;;</span><br><span class="line">		callResult-&gt;setExecResult(abi.abiIn(&quot;&quot;, updated_local_str);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        std::string epoch_str = GetVariable(table, _origin, callResult, EPOCH_FIELD_NAME);</span><br><span class="line">        int epoch = json::parse(epoch_str);</span><br><span class="line"></span><br><span class="line">		/*</span><br><span class="line">        // not current epoch  不是当前轮次</span><br><span class="line">        if(ep!=epoch)</span><br><span class="line">            return callResult;</span><br><span class="line"></span><br><span class="line">        std::string local_updates_str = GetVariable(table, _origin, callResult, LOCAL_UPDATES_FIELD_NAME);</span><br><span class="line">        Pair local_updates = json::parse(local_updates_str);</span><br><span class="line"></span><br><span class="line">        // local update is exist 本地更新存在</span><br><span class="line">        if(local_updates.find(_origin_str)!=local_updates.end())</span><br><span class="line">            return callResult;</span><br><span class="line"></span><br><span class="line">        std::string update_count_str = GetVariable(table, _origin, callResult, UPDATE_COUNT_FIELD_NAME);</span><br><span class="line">        size_t update_count = json::parse(update_count_str);</span><br><span class="line"></span><br><span class="line">        // if there are enougth updates  如果有足够的更新</span><br><span class="line">        if(update_count &gt;= NEEDED_UPDATE_COUNT)&#123;</span><br><span class="line">#if OUTPUT</span><br><span class="line">            std::clog&lt;&lt;&quot;the update of local model is not collected&quot;&lt;&lt;std::endl;</span><br><span class="line">#endif</span><br><span class="line">            return callResult;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        update_count += 1;</span><br><span class="line">        update_count_str = to_json_string(update_count);</span><br><span class="line"></span><br><span class="line">        local_updates[_origin_str] = update;</span><br><span class="line">        local_updates_str = to_json_string(local_updates);</span><br><span class="line"></span><br><span class="line">        UpdateVariable(table, _origin, callResult, UPDATE_COUNT_FIELD_NAME, update_count_str);</span><br><span class="line">        UpdateVariable(table, _origin, callResult, LOCAL_UPDATES_FIELD_NAME, local_updates_str);</span><br><span class="line"></span><br><span class="line">#if OUTPUT</span><br><span class="line">        std::clog&lt;&lt;&quot;the update of local model is collected&quot;&lt;&lt;std::endl;</span><br><span class="line">#endif</span><br><span class="line">*/</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	else if (func == name2Selector[UPLOAD_SCORES])&#123;             //上传分数</span><br><span class="line"></span><br><span class="line">		score_str = &quot;score of node has been updated!&quot;;</span><br><span class="line">		callResult-&gt;setExecResult(abi.abiIn(&quot;&quot;, score_str);</span><br><span class="line">	&#125;</span><br><span class="line">	else if (func == name2Selector[QUERY_ALL_UPDATES])&#123;         //获取所有本地更新</span><br><span class="line"></span><br><span class="line">		all_state_str = &quot;all state has been updated!&quot;;</span><br><span class="line">		callResult-&gt;setExecResult(abi.abiIn(&quot;&quot;, all_state_str);</span><br><span class="line">	&#125;</span><br><span class="line">	else if (func == name2Selector[UPDATED_GLOBAL_MODEL])&#123;        //接受上传的全局模型</span><br><span class="line">        //std::string global_model_str = GetVariable(table, _origin, callResult, Block_FL_GLOBAL_MODEL_KEY_FIELD_NAME);</span><br><span class="line">		// 0. get params  获取参数：上传的全局模型参数</span><br><span class="line">        s256 updated_epoch;</span><br><span class="line">        std::string global_model;</span><br><span class="line">        abi.abiOut(data, updated_epoch, global_model);</span><br><span class="line"></span><br><span class="line">		//将接收的模型和epoch转换为json形式并保存上链</span><br><span class="line">		std::string global_model_str = to_json_string(global_model);</span><br><span class="line">		std::string updated_epoch_str = to_json_string(updated_epoch);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		updated_model_str = &quot;global model has been updated!&quot;;</span><br><span class="line">		callResult-&gt;setExecResult(abi.abiIn(&quot;&quot;, updated_model_str,updated_epoch_str);</span><br><span class="line"></span><br><span class="line">        //std::string epoch_str = GetVariable(table, _origin, callResult, Block_FL_EPOCH_KEY_FIELD_NAME);</span><br><span class="line">        //int epoch = json::parse(epoch_str);</span><br><span class="line"></span><br><span class="line">        //callResult-&gt;setExecResult(abi.abiIn(&quot;&quot;, global_model_str, s256(epoch)));</span><br><span class="line">	&#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;  // unknown function call</span><br><span class="line">        PRECOMPILED_LOG(ERROR) &lt;&lt; LOG_BADGE(&quot;BlockandFLPrecompiled&quot;) &lt;&lt; LOG_DESC(&quot; unknown func &quot;)</span><br><span class="line">                               &lt;&lt; LOG_KV(&quot;func&quot;, func);</span><br><span class="line">        callResult-&gt;setExecResult(abi.abiIn(&quot;&quot;, u256(int32_t(CODE_UNKNOW_FUNCTION_CALL))));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return callResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// init global model   初始化全局模型</span><br><span class="line">void BlockandFLPrecompiled::InitGlobalModel(Table::Ptr table, Address const&amp; _origin, PrecompiledExecResult::Ptr callResult)&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Pair roles;</span><br><span class="line">    std::string roles_str = to_json_string(roles);</span><br><span class="line">    InsertVariable(table, _origin, callResult, Block_FL_ROLES_KEY_FIELD_NAME, roles_str);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">//插入变量</span><br><span class="line">void BlockandFLPrecompiled::InsertVariable(Table::Ptr table, Address const&amp; _origin, PrecompiledExecResult::Ptr callResult, const std::string &amp; Key, std::string &amp; strValue)&#123;</span><br><span class="line">    int count = 0;</span><br><span class="line">    auto entry = table-&gt;newEntry();</span><br><span class="line">    entry-&gt;setField(Block_FL_KEY_FIELD, Key);</span><br><span class="line">    entry-&gt;setField(Block_FL_VALUE_FIELD, strValue);</span><br><span class="line">    count = table-&gt;insert(</span><br><span class="line">         Key, entry, std::make_shared&lt;AccessOptions&gt;(_origin));</span><br><span class="line">    if (count &gt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        callResult-&gt;gasPricer()-&gt;updateMemUsed(entry-&gt;capacity() * count);</span><br><span class="line">        callResult-&gt;gasPricer()-&gt;appendOperation(InterfaceOpcode::Insert, count);</span><br><span class="line">    &#125;</span><br><span class="line">    if (count == storage::CODE_NO_AUTHORIZED)</span><br><span class="line">    &#123;  //  permission denied 许可拒绝</span><br><span class="line">        PRECOMPILED_LOG(ERROR) &lt;&lt; LOG_BADGE(&quot;BlockandFLPrecompiled&quot;) &lt;&lt; LOG_DESC(&quot;set&quot;)</span><br><span class="line">                                &lt;&lt; LOG_DESC(&quot;permission denied&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    getErrorCodeOut(callResult-&gt;mutableExecResult(), count);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// get variable   获取变量</span><br><span class="line">std::string CommitteePrecompiled::GetVariable(Table::Ptr table, Address const&amp;, PrecompiledExecResult::Ptr callResult, const std::string &amp; Key)&#123;</span><br><span class="line">    auto entries = table-&gt;select(Key, table-&gt;newCondition());</span><br><span class="line">    std::string retValue = &quot;&quot;;</span><br><span class="line">    if (0u != entries-&gt;size())</span><br><span class="line">    &#123;</span><br><span class="line">        callResult-&gt;gasPricer()-&gt;updateMemUsed(getEntriesCapacity(entries));</span><br><span class="line">        callResult-&gt;gasPricer()-&gt;appendOperation(InterfaceOpcode::Select, entries-&gt;size());</span><br><span class="line">        auto entry = entries-&gt;get(0);</span><br><span class="line">        retValue = entry-&gt;getField(Block_FL_VALUE_FIELD);</span><br><span class="line">    &#125;</span><br><span class="line">    return retValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// update variable  更新变量</span><br><span class="line">void BlockandFLPrecompiled::UpdateVariable(Table::Ptr table, Address const&amp; _origin, PrecompiledExecResult::Ptr callResult, const std::string &amp; Key, std::string &amp; strValue)&#123;</span><br><span class="line">    int count = 0;</span><br><span class="line">    auto entry = table-&gt;newEntry();</span><br><span class="line">    entry-&gt;setField(Block_FL_KEY_FIELD, Key);</span><br><span class="line">    entry-&gt;setField(Block_FL_VALUE_FIELD, strValue);</span><br><span class="line">    count = table-&gt;update(</span><br><span class="line">         Key, entry, table-&gt;newCondition(), std::make_shared&lt;AccessOptions&gt;(_origin));</span><br><span class="line">    if (count &gt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        callResult-&gt;gasPricer()-&gt;updateMemUsed(entry-&gt;capacity() * count);</span><br><span class="line">        callResult-&gt;gasPricer()-&gt;appendOperation(InterfaceOpcode::Update, count);</span><br><span class="line">    &#125;</span><br><span class="line">    if (count == storage::CODE_NO_AUTHORIZED)</span><br><span class="line">    &#123;  //  permission denied  许可拒绝</span><br><span class="line">        PRECOMPILED_LOG(ERROR) &lt;&lt; LOG_BADGE(&quot;BlockandFLPrecompiled&quot;) &lt;&lt; LOG_DESC(&quot;set&quot;)</span><br><span class="line">                                &lt;&lt; LOG_DESC(&quot;permission denied&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    getErrorCodeOut(callResult-&gt;mutableExecResult(), count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h4 id="solidity合约"><a href="#solidity合约" class="headerlink" title="solidity合约"></a>solidity合约</h4></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.24;</span><br><span class="line"></span><br><span class="line">contract CommitteePrecompiled&#123;</span><br><span class="line">  function RegisterNode() public;                               //节点注册</span><br><span class="line">  function QueryState() public view returns(string, int);       //查询状态</span><br><span class="line">  function QueryGlobalModel() public view returns(string, int); //获取全局模型</span><br><span class="line">  function UploadLocalUpdate(string update, int256 epoch) public;//上传本地模型更新</span><br><span class="line">  function UploadScores(int256 epoch, string scores) public;     //上传分数</span><br><span class="line">  func QueryAllUpdates()public view returns(string);             //获取所有本地模型</span><br><span class="line">  function InitGlobalModel() public;                             //上传初始化的全局模型</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="2、在Ubuntu虚拟机上编译部署"><a href="#2、在Ubuntu虚拟机上编译部署" class="headerlink" title="2、在Ubuntu虚拟机上编译部署"></a>2、在Ubuntu虚拟机上编译部署</h2><ul>
<li><h3 id="部署fisco-bcos环境"><a href="#部署fisco-bcos环境" class="headerlink" title="部署fisco-bcos环境"></a>部署fisco-bcos环境</h3><ul>
<li><h4 id="1-进入Ubuntu创建工作目录"><a href="#1-进入Ubuntu创建工作目录" class="headerlink" title="1.进入Ubuntu创建工作目录"></a>1.进入Ubuntu创建工作目录</h4></li>
</ul>
<p> <code>mkdir -p work</code></p>
<ul>
<li><h4 id="2-下载FISCO-BCOS源码"><a href="#2-下载FISCO-BCOS源码" class="headerlink" title="2.下载FISCO-BCOS源码"></a>2.下载FISCO-BCOS源码</h4></li>
</ul>
<p> <code>git clone https://github.com/FISCO-BCOS/FISCO-BCOS.git</code>或者 <code>git clone https://gitee.com/FISCO-BCOS/FISCO-BCOS.git</code><br> 注：如果下载的版本不对：进入下载的FISCO-BCOS目录：<code>cd FISCO-BCOS</code>;输入命令：<code>git checkout release-2.8.0</code>(checkout后面的版本可根据需要填写)<br> -#### 3.嵌入预编译智能合约<br> 放置预编译合约文件.cpp和.h文件在&lt;working_dir&gt;&#x2F;FISCO-BCOS&#x2F;libprecompiled&#x2F;extension 目录下<br> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|---extension</span><br><span class="line">     |---CmakeLists.txt</span><br><span class="line">     |---CommitteePrecompiled.cpp</span><br><span class="line">     |---CommitteePrecompiled.h</span><br><span class="line">     |---......</span><br></pre></td></tr></table></figure></p>
<ul>
<li><h4 id="4-分配并注册合约地址"><a href="#4-分配并注册合约地址" class="headerlink" title="4.分配并注册合约地址"></a>4.分配并注册合约地址</h4></li>
</ul>
<p> 通过修改 &lt;working_dir&gt;&#x2F;FISCO-BCOS&#x2F;cmake&#x2F;templates&#x2F;UserPrecompiled.h.in 文件，在 registerUserPrecompiled 函数中注册 CommitteePrecompiled 合约地址<br> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void dev::blockverifier::ExecutiveContextFactory::registerUserPrecompiled(dev::blockverifier::ExecutiveContext::Ptr context)</span><br><span class="line">&#123;</span><br><span class="line"> // Address should in [0x5001,0xffff]</span><br><span class="line"> context-&gt;setAddress2Precompiled(</span><br><span class="line">     Address(0x5006), std::make_shared&lt;dev::precompiled::CommitteePrecompiled&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><h4 id="5-源码编译"><a href="#5-源码编译" class="headerlink" title="5.源码编译"></a>5.源码编译</h4></li>
</ul>
<h5 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h5><pre><code>`sudo apt install -y g++ libssl-dev openssl cmake git build-essential autoconf texinfo flex patch bison libgmp-dev zlib1g-dev`
</code></pre>
<h5 id="第三方库嵌入-下载nlohmann"><a href="#第三方库嵌入-下载nlohmann" class="headerlink" title="第三方库嵌入 下载nlohmann"></a>第三方库嵌入 下载nlohmann</h5><pre><code>- 由于该项目需要对复杂数据结构进行序列化和反序列化，因此，该项目采用了第三方(nlohmann) JSON 序列化/反序列化库
`cd ~/FISCO-BCOS`
`git clone https://github.com/nlohmann/json.git`
- 修改文件夹名称
`mv json/ libnlohmann_json`
</code></pre>
<h5 id="CmakeLists-txt配置"><a href="#CmakeLists-txt配置" class="headerlink" title="CmakeLists.txt配置"></a>CmakeLists.txt配置</h5><pre><code>\&lt;working_dir&gt;/FISCO-BCOS/CMakeLists.txt
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"># 以下命令放在add_subdirectory(libnlohmann_json)命令之前</span><br><span class="line">set(JSON_BuildTests OFF CACHE INTERNAL &quot;&quot;)</span><br><span class="line">...</span><br><span class="line"># 以下命令放在该文件中add_subdirectory部分的任意位置</span><br><span class="line">add_subdirectory(libnlohmann_json)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</code></pre>
<h5 id="头文件引入"><a href="#头文件引入" class="headerlink" title="头文件引入"></a>头文件引入</h5><pre><code>使用该第三方库时，在.h或者.cpp文件中加入以下语句。本项目在CommitteePrecompiled.h文件中已加入以下语句，无需再次添加
`#include &lt;libnlohmann_json/single_include/nlohmann/json.hpp&gt;`
</code></pre>
<h5 id="建立build目录"><a href="#建立build目录" class="headerlink" title="建立build目录"></a>建立build目录</h5><pre><code>`cd ~/FISCO-BCOS`
`mkdir -p build &amp;&amp; cd build`
</code></pre>
<h5 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h5>   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cmake ..</span><br><span class="line"># 根据机器性能自行选用并行编译</span><br><span class="line">make -j4</span><br><span class="line"># 编译完成后在该目录下 ./bin 文件夹生成以下区块链运行所需的可执行程序 fisco-bcos</span><br></pre></td></tr></table></figure>
<p>  编译问题参考链接：<a target="_blank" rel="noopener" href="https://fisco-bcos-documentation.readthedocs.io/zh_CN/latest/docs/faq/compile.html">https://fisco-bcos-documentation.readthedocs.io/zh_CN&#x2F;latest&#x2F;docs&#x2F;faq&#x2F;compile.html</a><br>  如果因为网络问题导致长时间无法下载依赖库，请尝试从 <a target="_blank" rel="noopener" href="https://gitee.com/FISCO-BCOS/LargeFiles/tree/master/libs"> https://gitee.com/FISCO-BCOS/LargeFiles/tree/master/libs</a> 下载，放在&lt;working_dir&gt;&#x2F;FISCO-BCOS&#x2F;deps&#x2F;src&#x2F;<br> -#### 6.搭建单群组多节点联盟链</p>
<h5 id="安装依赖-1"><a href="#安装依赖-1" class="headerlink" title="安装依赖"></a>安装依赖</h5><p> <code>sudo apt install -y openssl curl</code></p>
<h5 id="下载建链脚本"><a href="#下载建链脚本" class="headerlink" title="下载建链脚本"></a>下载建链脚本</h5> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 创建操作目录</span><br><span class="line">cd ~ &amp;&amp; mkdir -p fisco &amp;&amp; cd fisco</span><br><span class="line"># 下载脚本</span><br><span class="line">curl -LO https://github.com/FISCO-BCOS/FISCO-BCOS/releases/download/v2.7.2/build_chain.sh &amp;&amp; chmod u+x build_chain.sh</span><br></pre></td></tr></table></figure>
<h5 id="搭建单群组4节点联盟链"><a href="#搭建单群组4节点联盟链" class="headerlink" title="搭建单群组4节点联盟链"></a>搭建单群组4节点联盟链</h5><p> 在 ip 为127.0.0.1下建立4个节点的区块链网络，每个节点后台运行fisco-bcos可执行程序，每个节点占用三个端口，节点的p2p，channel，jsonrpc起始端口分别为：30300，20200，8545。请确保端口没有被占用。<br> <code>bash build_chain.sh -l 127.0.0.1:4 -p 30300,20200,8545 -e ~/FISCO-BCOS/build/bin/fisco-bcos</code></p>
<h5 id="启动联盟链-停止联盟链"><a href="#启动联盟链-停止联盟链" class="headerlink" title="启动联盟链&#x2F;停止联盟链"></a>启动联盟链&#x2F;停止联盟链</h5><p> 启动所有节点<br> <code>bash nodes/127.0.0.1/start_all.sh</code><br> 停止所有节点<br> <code>bash nodes/127.0.0.1/stop_all.sh</code></p>
<ul>
<li><h4 id="7-客户端配置"><a href="#7-客户端配置" class="headerlink" title="7.客户端配置"></a>7.客户端配置</h4></li>
</ul>
<h5 id="7-1-Python-SDK安装与配置"><a href="#7-1-Python-SDK安装与配置" class="headerlink" title="7.1 Python SDK安装与配置"></a>7.1 Python SDK安装与配置</h5><h6 id="软件依赖"><a href="#软件依赖" class="headerlink" title="软件依赖"></a>软件依赖</h6><p> <code>sudo apt install -y zlib1g-dev libffi6 libffi-dev wget git</code></p>
<h6 id="拉取官方源代码"><a href="#拉取官方源代码" class="headerlink" title="拉取官方源代码"></a>拉取官方源代码</h6> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 第一步：</span><br><span class="line">git clone https://github.com/FISCO-BCOS/python-sdk</span><br><span class="line"># 第二步：</span><br><span class="line"># 在官方源代码中增加本项目中python-sdk文件夹下相关文件到相应的地方</span><br></pre></td></tr></table></figure>
<h6 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h6><p> 若已有符合版本要求的python环境，则直接进入该环境。本项目直接进入符合版本要求，且配置了tensorflow框架的python虚拟环境<br> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># source activate (env_name)</span><br><span class="line">source activate tensorflow-gpu</span><br><span class="line">cd python-sdk</span><br></pre></td></tr></table></figure><br> 若常用python环境不符合版本要求，请重新安装。或不存在已有python环境，则输入以下命令<br> <figure class="highlight plaintext"><figcaption><span>python-sdk && bash init_env.sh -p</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 激活python-sdk虚拟环境</span><br><span class="line">source ~/.bashrc &amp;&amp; pyenv activate python-sdk &amp;&amp; pip install --upgrade pip</span><br></pre></td></tr></table></figure></p>
<h6 id="安装依赖-2"><a href="#安装依赖-2" class="headerlink" title="安装依赖"></a>安装依赖</h6><p> <code>pip install -r requirements.txt</code></p>
<h6 id="初始化配置"><a href="#初始化配置" class="headerlink" title="初始化配置"></a>初始化配置</h6> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 使用模板的默认配置初始化客户端配置</span><br><span class="line">cp client_config.py.template client_config.py</span><br><span class="line"># 根据配置下载solc编译器</span><br><span class="line">bash init_env.sh -i</span><br></pre></td></tr></table></figure>
<h6 id="配置Channel通信协议"><a href="#配置Channel通信协议" class="headerlink" title="配置Channel通信协议"></a>配置Channel通信协议</h6><p> Channel协议是FISCO BCOS特有的加密通信协议，具有良好的机密性。根据建链时节点配置的Channel端口，修改 &lt;working_dir&gt;&#x2F;python-sdk&#x2F;client_config.py 文件<br> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 本项目建链时，ip=127.0.0.1，节点0的channel_listen_port=20200</span><br><span class="line">channel_host = &quot;127.0.0.1&quot;</span><br><span class="line">channel_port = 20200</span><br></pre></td></tr></table></figure></p>
<h6 id="配置证书"><a href="#配置证书" class="headerlink" title="配置证书"></a>配置证书</h6><p> <code>cp ~/fisco/nodes/127.0.0.1/sdk/* bin/</code></p>
<h6 id="配置证书路径，修改-python-sdk-client-config-py-文件"><a href="#配置证书路径，修改-python-sdk-client-config-py-文件" class="headerlink" title="配置证书路径，修改 &lt;working_dir&gt;&#x2F;python-sdk&#x2F;client_config.py 文件"></a>配置证书路径，修改 &lt;working_dir&gt;&#x2F;python-sdk&#x2F;client_config.py 文件</h6> <figure class="highlight plaintext"><figcaption><span>根据从节点拷贝的sdk证书路径，设置sdk证书和私钥路径</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">channel_node_cert = &quot;bin/sdk.crt&quot;</span><br><span class="line">channel_node_key = &quot;bin/sdk.key&quot;</span><br></pre></td></tr></table></figure>
<h5 id="7-2-定义预编译合约接口"><a href="#7-2-定义预编译合约接口" class="headerlink" title="7.2 定义预编译合约接口"></a>7.2 定义预编译合约接口</h5><p> 在 &lt;working_dir&gt;&#x2F;python-sdk&#x2F;contracts 目录下创建 CommitteePrecompiled.sol 文件声明合约接口<br> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.24;</span><br><span class="line"></span><br><span class="line">contract CommitteePrecompiled&#123;</span><br><span class="line">   function RegisterNode() public;                                   //节点注册</span><br><span class="line">   function QueryState() public view returns(string, int);     	  //查询状态</span><br><span class="line">   function QueryGlobalModel() public view returns(string, int);     //获取全局模型</span><br><span class="line">   function UploadLocalUpdate(string update, int256 epoch) public;   //上传本地模型</span><br><span class="line">   function UploadScores(int256 epoch, string scores) public;        //上传评分</span><br><span class="line">   function QueryAllUpdates() public view returns(string);           //获取所有本地模型</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="7-3-测试账户生成"><a href="#7-3-测试账户生成" class="headerlink" title="7.3 测试账户生成"></a>7.3 测试账户生成</h5><h6 id="获取脚本"><a href="#获取脚本" class="headerlink" title="获取脚本"></a>获取脚本</h6> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/python-sdk/bin</span><br><span class="line">curl -LO https://raw.githubusercontent.com/FISCO-BCOS/LargeFiles/master/tools/get_account.sh &amp;&amp; chmod u+x get_account.sh &amp;&amp; bash get_account.sh -h</span><br></pre></td></tr></table></figure>
<h6 id="生成PEM格式账户私钥（若需批量生成，忽略此步骤）"><a href="#生成PEM格式账户私钥（若需批量生成，忽略此步骤）" class="headerlink" title="生成PEM格式账户私钥（若需批量生成，忽略此步骤）"></a>生成PEM格式账户私钥（若需批量生成，忽略此步骤）</h6><p> <code>bash get_account.sh</code></p>
<h6 id="批量生成测试账户私钥"><a href="#批量生成测试账户私钥" class="headerlink" title="批量生成测试账户私钥"></a>批量生成测试账户私钥</h6><p> 创建 &lt;working_dir&gt;&#x2F;python-sdk&#x2F;bin&#x2F;get_batch_accounts.sh 脚本文件，调用get_account.sh批量生成20个测试账户<br> <code>bash get_batch_accounts.sh -n 20</code></p>
<h5 id="7-4-用户代码准备"><a href="#7-4-用户代码准备" class="headerlink" title="7.4 用户代码准备"></a>7.4 用户代码准备</h5><h6 id="加载abi定义"><a href="#加载abi定义" class="headerlink" title="加载abi定义"></a>加载abi定义</h6> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> from client.datatype_parser import DatatypeParser</span><br><span class="line"> from client.common.compiler import Compiler</span><br><span class="line"> from client_config import client_config</span><br><span class="line"> ...</span><br><span class="line">#  编译合约接口</span><br><span class="line">if os.path.isfile(client_config.solc_path) or os.path.isfile(client_config.solcjs_path):</span><br><span class="line">    Compiler.compile_file(&quot;contracts/CommitteePrecompiled.sol&quot;)</span><br><span class="line">    # 从文件加载abi定义</span><br><span class="line">    abi_file = &quot;contracts/CommitteePrecompiled.abi&quot;</span><br><span class="line">    data_parser = DatatypeParser()</span><br><span class="line">    data_parser.load_abi_file(abi_file)</span><br><span class="line">    contract_abi = data_parser.contract_abi</span><br></pre></td></tr></table></figure>
<h6 id="合约地址"><a href="#合约地址" class="headerlink" title="合约地址"></a>合约地址</h6> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 定义合约地址</span><br><span class="line">to_address = &quot;0x0000000000000000000000000000000000005006&quot;</span><br></pre></td></tr></table></figure>
<h6 id="初始化BCOS客户端"><a href="#初始化BCOS客户端" class="headerlink" title="初始化BCOS客户端"></a>初始化BCOS客户端</h6> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from client.bcosclient import BcosClient</span><br><span class="line">from client.bcoserror import BcosException, BcosError</span><br><span class="line">...</span><br><span class="line">try:</span><br><span class="line">   ...</span><br><span class="line">   # 实例化</span><br><span class="line">   client = BcosClient()</span><br><span class="line">   # 为了模拟多个客户端，加载创建的测试账户</span><br><span class="line">   client.set_from_account_signer(node_id)</span><br><span class="line">   ...</span><br><span class="line"> except Exception as e:</span><br><span class="line">   client.finish()</span><br><span class="line">   traceback.print_exc()</span><br></pre></td></tr></table></figure>
<h6 id="在-python-sdk-client-bcosclient-py-加入以下函数"><a href="#在-python-sdk-client-bcosclient-py-加入以下函数" class="headerlink" title="在 &lt;working_dir&gt;&#x2F;python-sdk&#x2F;client&#x2F;bcosclient.py 加入以下函数"></a>在 &lt;working_dir&gt;&#x2F;python-sdk&#x2F;client&#x2F;bcosclient.py 加入以下函数</h6> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class BcosClient:</span><br><span class="line"> ...</span><br><span class="line"> def set_from_account_signer(self, node_id):</span><br><span class="line">     self.key_file = &quot;&#123;&#125;/&#123;&#125;.pem&quot;.format(client_config.account_keyfile_path,</span><br><span class="line">                                        node_id)</span><br><span class="line">     self.default_from_account_signer = Signer_ECDSA.from_key_file(</span><br><span class="line">         self.key_file, None)</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>
<h5 id="7-5-接口调用"><a href="#7-5-接口调用" class="headerlink" title="7.5 接口调用"></a>7.5 接口调用</h5><h6 id="节点注册"><a href="#节点注册" class="headerlink" title="节点注册"></a>节点注册</h6><p> <code>receipt = client.sendRawTransactionGetReceipt(to_address, contract_abi, &quot;RegisterNode&quot;, [])</code></p>
<h6 id="节点查询状态"><a href="#节点查询状态" class="headerlink" title="节点查询状态"></a>节点查询状态</h6><p> <code>role, global_epoch =  client.call(to_address, contract_abi, &quot;QueryState&quot;)</code></p>
<h6 id="获取全局模型"><a href="#获取全局模型" class="headerlink" title="获取全局模型"></a>获取全局模型</h6><p> <code>model, epoch = client.call(to_address, contract_abi, &quot;QueryGlobalModel&quot;)</code></p>
<h6 id="上传本地更新"><a href="#上传本地更新" class="headerlink" title="上传本地更新"></a>上传本地更新</h6><p> <code>receipt = client.sendRawTransactionGetReceipt(to_address, contract_abi, &quot;UploadLocalUpdate&quot;, [update_model, epoch])</code></p>
<h6 id="上传评分"><a href="#上传评分" class="headerlink" title="上传评分"></a>上传评分</h6><p> <code>receipt = client.sendRawTransactionGetReceipt(to_address, contract_abi, &quot;UploadScores&quot;, [epoch, serialize(scores)])</code></p>
<h6 id="获取所有本地更新"><a href="#获取所有本地更新" class="headerlink" title="获取所有本地更新"></a>获取所有本地更新</h6><p> <code>res = client.call(to_address, contract_abi, &quot;QueryAllUpdates&quot;)</code><br> <code>updates = res[0]</code></p>
</li>
</ul>
<h2 id="3、运行结果"><a href="#3、运行结果" class="headerlink" title="3、运行结果"></a>3、运行结果</h2><h3 id="运行-python-sdk-main-py-文件"><a href="#运行-python-sdk-main-py-文件" class="headerlink" title="运行 &lt;working_dir&gt;&#x2F;python-sdk&#x2F;main.py 文件"></a>运行 &lt;working_dir&gt;&#x2F;python-sdk&#x2F;main.py 文件</h3>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/03/13/fisco-bcos%20shiyan/" data-id="cltpinrdg0002swrodnew40va" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2024/03/06/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/03/13/fisco-bcos%20shiyan/">(no title)</a>
          </li>
        
          <li>
            <a href="/2024/03/06/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>